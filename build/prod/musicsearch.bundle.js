"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,o=Array(e.length);t<e.length;t++)o[t]=e[t];return o}return Array.from(e)}angular.module("albums",["modalHelper"]).controller("albumsCtrl",["$scope","modalHelper",function(e,t){e.model=[],e.showLoader=!0;var o="openAlbumsModal";t.on("reset",function(r){o===r&&(e.model=t.getModel())}),t.on("showLoader",function(t){o===t&&(e.showLoader=!0)}),t.on("hideLoader",function(t){o===t&&(e.showLoader=!1)}),t.on("clearModel",function(t){o===t&&(e.model=[])}),e.getPic=t.getPic,e.close=function(){t.publish("close",[e.model.modalId])}}]);var base=angular.module("base",["home","albums","tracks","spotifySrvc"]);base.config(["$locationProvider",function(e){e.html5Mode(!0)}]),base.run(["spotify",function(e){e.authorize()}]);var home=angular.module("home",["spotifySrvc","modalHelper"]);home.controller("homeCtrl",["$scope","$rootScope","spotify","modalHelper",function(e,t,o,r){e.query="",e.currentQuery="",e.results=null,e.showUpperLoader=!1,e.showLowerLoader=!1,t.openAlbumsModal=!1,t.openTracksModal=!1;var a={albums:"openAlbumsModal",tracks:"openTracksModal"},n=["all_albums","top_tracks","album"];r.on("close",function(e){t[e]=!1});var l=function(t,o){return{header:{pic:e.getPic(t),name:t.name},tracks:o,type:t.type,modalId:a.tracks}},s=function(t,o){return{header:{pic:e.getPic(t),name:t.name},albums:o,modalId:a.albums}};e.search=function(t){0!==t.trim().length&&(e.currentQuery=t,e.showUpperLoader=!0,o.search(e.currentQuery,function(t){e.results=o.normalize(t),e.showUpperLoader=!1}))},e.getPic=function(t){var o="";return t.images?1===t.images.length?o=t.images[0]:t.images.length>0&&(o=t.images[1]):o={url:e.getPic(t.album)},o.url},e.more=function(){e.showLowerLoader=!0,o.searchMore(e.currentQuery,function(t){var o;(o=e.results).push.apply(o,_toConsumableArray(t)),e.showLowerLoader=!1})},e.showBlurred=function(e){return["all_albums","top_tracks"].indexOf(e.type)>-1},e.show=function(e){-1!==n.indexOf(e.type)&&("all_albums"===e.type?(r.clearModel(a.albums),t.openAlbumsModal=!0,r.publish("showLoader",[a.albums]),o.getAlbumsByArtistID(e.id,function(t){var o=s(e,t);r.setModel(o),r.publish("hideLoader",[a.albums])})):"top_tracks"===e.type?(r.clearModel(a.tracks),t.openTracksModal=!0,r.publish("showLoader",[a.tracks]),o.getTracksByArtistID(e.id,function(t){var o=l(e,t);r.setModel(o),r.publish("hideLoader",[a.tracks])})):"album"===e.type&&(r.clearModel(a.tracks),t.openTracksModal=!0,r.publish("showLoader",[a.tracks]),o.getAlbumTracksByID(e.id,function(t){var o=l(e,t);r.setModel(o),r.publish("hideLoader",[a.tracks])})))}}]);var CLIENT_ID="0bd2b7d36b5344faa55a8d4cf0ee104b";angular.module("modalHelper",[]).factory("modalHelper",function(){var e={},t={reset:[],close:[],showLoader:[],hideLoader:[],clearModel:[]},o=function(t){a("reset",[(e=t).modalId])},r=function(t){e={},a("clearModel",[t])},a=function(e,o){if(!t[e])throw"modalHelper: cannot publish unknown "+e+" event";t[e].forEach(function(e){return e.apply(void 0,_toConsumableArray(o))})};return{setModel:o,getModel:function(){return e},on:function(e,o){if(!t[e])throw"modalHelper: cannot subscribe to unknown '"+e+"' event";t[e].push(o)},publish:a,getPic:function(e){var t=0;return e.images.length>1&&(t=e.images.length-2),e.images[t].url},clearModel:r}});var spot=angular.module("spotifySrvc",["utils"]);spot.factory("spotify",["ajax","arrays","lstorage","$timeout",function(e,t,o,r){var a="https://api.spotify.com/v1",n=encodeURIComponent(window.location.href),l="",s=0,i="access_token",u=function(e){var o={},r=e.artists.items.shift(),a=e.albums.items.shift(),n=c(e);return t.shuffle(n),r&&((o=angular.copy(r)).type="top_tracks",n.unshift(o)),a&&((o=angular.copy(r)).type="all_albums",n.unshift(o)),a&&n.unshift(a),r&&n.unshift(r),n},c=function(e){var t=e.artists.items;return t=t.concat(e.albums.items)},d=function(e){return{Authorization:"Bearer "+e}},f=function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=n.limit||5,u=!angular.isDefined(n.albums)||n.albums,c=!angular.isDefined(n.artists)||n.artists,f=!angular.isDefined(n.tracks)||n.tracks,m=[],h=0,p="",g="",y={};if(!u&&!c&&!f)throw"spotifySrvc: you have to search either for artist, tracks or albums";h=n.pageIdx?n.pageIdx*s:0,p=a+"/search?q="+t+"&market=US&type=",g=o.get(i),y=d(g),c&&m.push("artist"),u&&m.push("album"),f&&m.push("track"),p+=m.join(","),p+="&limit="+s,l=t,h>0&&(p+="&offset="+h),e.call(p,{},function(e){return r(e.data)},function(e){return console.log(e)},"get",y)},m=function(t,r){var n=a+"/albums/"+t+"/tracks?market=US",l=o.get(i),s=d(l);e.call(n,{},function(e){var t=e.data.items;t=t.sort(b),r(t)},function(e){return console.log(e.data)},"get",s)},h=function(t,r){var n=a+"/albums?ids="+t.join(",");n+="&market=US",n+="&album_type=album";var l=o.get(i),s=d(l);e.call(n,{},function(e){var t=e.data.albums;r(t)},function(e){return console.log(e.data)},"get",s)},p=function(e){var t=e.release_date;return"year"!=e.release_date_precision&&(t=t.slice(0,t.indexOf("-"))),t},g=function(t,r){var n=a+"/artists/"+t+"/albums?market=US",l=o.get(i),s=d(l);e.call(n,{},function(e){for(var t=[],o=e.data.items.sort(b),a=0;a<o.length&&!(a>20);a++)t.push(o[a].id);h(t,function(e){e.forEach(function(e){e.release_year=p(e)}),r(e)})},function(e){return console.log(e.data)},"get",s)},y=function(t,r){var n=a+"/artists/"+t+"/top-tracks?country=US",l=o.get(i),s=d(l);e.call(n,{},function(e){var t=e.data.tracks;t=t.sort(b),r(t)},function(e){return console.log(e.data)},"get",s)},b=function(e,t){return t.popularity-e.popularity};return{search:f,searchMore:function(e,t){f(e,function(e){t(c(e))},{pageIdx:s=l!=e?0:s+1})},concatenateResults:c,normalize:u,authorize:function(){var e=o.get(i);if(!e)if(-1===window.location.href.indexOf(i)){var t="https://accounts.spotify.com/authorize?";t+="client_id="+CLIENT_ID,t+="&response_type=token",t+="&redirect_uri="+n,t+="&state=118",window.location.href=t}else{var r=window.location.href,a=r.indexOf("access_token");e=r.slice(r.indexOf("=",a)+1,r.indexOf("&",a)),o.set(i,e),window.location.href=r.slice(0,r.indexOf("#"))}},getAlbumTracksByID:m,getAlbumsByArtistID:g,getTracksByArtistID:y,getAlbumsDetailsByID:h}}]),angular.module("tracks",["modalHelper"]).controller("tracksCtrl",["$scope","modalHelper",function(e,t){e.model=[],e.showLoader=!0;var o="openTracksModal";t.on("reset",function(r){if(o===r){var a=t.getModel();a.tracks.forEach(function(e){e.duration=moment.utc(e.duration_ms).format("m:ss")}),e.showLoader=!1,e.model=a}}),t.on("showLoader",function(t){o===t&&(e.showLoader=!0)}),t.on("hideLoader",function(t){o===t&&(e.showLoader=!1)}),t.on("clearModel",function(t){o===t&&(e.model=[])}),e.getPic=t.getPic,e.close=function(){t.publish("close",[e.model.modalId])}}]);var utils=angular.module("utils",[]);utils.factory("ajax",["$http",function(e){return{call:function(t,o,r,a){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"post",l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return l["Content-Type"]="application/x-www-form-urlencoded",e({method:n,headers:l,url:t,data:o}).then(r,a)}}}]),utils.factory("arrays",["$http",function(e){return{shuffle:function e(t){var o=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=void 0,a=void 0,n=void 0;for(r=t.length-1;r>0;r--)a=Math.floor(Math.random()*(r+1)),n=t[r],t[r]=t[a],t[a]=n;return o||e(t,!0),t}}}]),utils.factory("lstorage",function(){return{get:function(e){var t=window.localStorage.getItem(e);try{t=JSON.parse(t)}catch(e){t=t.replace("/","")}return t},set:function(e,t){var o=t;angular.isObject(o)?o=JSON.stringify(t):angular.isNumber(t)&&(o="/"+o),window.localStorage.setItem(e,o)},remove:function(e){return window.localStorage.removeItem(e)},clear:function(){return window.localStorage.clear()}}});